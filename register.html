<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register | Yuba Technology</title>

    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./lib/fontawesome-free-5.15.4-web/css/all.min.css">
    <script src="./lib/jquery/js/jquery-3.6.3.min.js"></script>
</head>

<body>
    <link rel="stylesheet" href="css/account-form.css">

    <!-- Register OK -->

    <div class="modal" id="register-success-modal">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title">Success</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="text-center">
                        <svg style="width: 4em;height: 4em;vertical-align: middle;fill: currentColor;overflow: hidden;"
                            viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26053">
                            <path
                                d="M773.928 355.059L484.22 699.125c-12.893 14.506-34.877 16.379-50.04 4.225L259.05 537.537c-1.893-1.805-3.445-3.803-4.805-5.893-3.617-5.059-5.811-11.211-5.811-17.924 0-17.042 13.808-30.864 30.87-30.864 5.359 0 10.329 1.483 14.718 3.883 0.424 0.239 0.909 0.418 1.306 0.663l0.636 0.396c0.314 0.205 0.643 0.418 0.965 0.637l154.369 100.482c2.037 1.34 4.71 1.066 6.438-0.629l275.599-270.828c10.76-10.568 28-10.575 38.771-0.027C782.473 327.564 783.266 343.971 773.928 355.059M513.943 60.128c-247.42 0-448 200.58-448 448s200.58 448 448 448c247.434 0 448-200.58 448-448S761.377 60.128 513.943 60.128z"
                                fill="#07c160" p-id="26054"></path>
                        </svg>
                    </div>
                    <div class="m-4">
                        <p class="h6">
                            Thank you for submitting your request. Our server is currently processing it, which may take
                            some
                            time.
                        </p>
                        <p>You will receive an email from us shortly, regardless of whether the registration is
                            successful or not, to update you on the status of your request.
                        </p>
                        <p>
                            It may take a few minutes to active your account after you received the email.
                        </p>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="./login.html" class="btn btn-primary">Bring me to sign in</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Failure -->
    <div class="modal" id="register-failure-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Failure</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="text-center">
                        <svg class="icon"
                            style="width: 4em;height: 4em;vertical-align: middle;fill: currentColor;overflow: hidden;"
                            viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6722">
                            <path
                                d="M512 0C229.376 0 0 229.376 0 512s229.376 512 512 512 512-229.376 512-512S794.624 0 512 0z m218.624 672.256c15.872 15.872 15.872 41.984 0 57.856-8.192 8.192-18.432 11.776-29.184 11.776s-20.992-4.096-29.184-11.776L512 569.856l-160.256 160.256c-8.192 8.192-18.432 11.776-29.184 11.776s-20.992-4.096-29.184-11.776c-15.872-15.872-15.872-41.984 0-57.856L454.144 512 293.376 351.744c-15.872-15.872-15.872-41.984 0-57.856 15.872-15.872 41.984-15.872 57.856 0L512 454.144l160.256-160.256c15.872-15.872 41.984-15.872 57.856 0 15.872 15.872 15.872 41.984 0 57.856L569.856 512l160.768 160.256z"
                                fill="#CF3736" p-id="6723"></path>
                        </svg>
                    </div>
                    <div class="m-4">
                        <p class="h6">
                            We regret to inform you that your registration on our website has failed. <span
                                id="register-failure-reason"></span>
                        </p>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="account-form-header mt-5 mb-3 p-0 text-center">
        <h1>Register a new account</h1>
    </div>

    <div class="account-form">
        <div id="register-send-a-mail" class="account-form-body text-center">
            <svg class="icon" style="width: 5em;height: 5em;vertical-align: middle;fill: currentColor;overflow: hidden;"
                viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9097">
                <path
                    d="M310.496 420.886l0.064-0.126-3.398-2.934-44.63-37.81h550.966v51.596L568.442 640.162zM216.922 410.548l243.862 206.466-243.862 207.824zM262.158 855.538l239.388-203.95 67.1 56.754 3.294-3.12 63.572-53.84 239.39 204.156zM860.248 773.754l-3.208-2.312-180.764-153.062 0.868-0.744-0.876-0.746 183.882-155.696 0.226 0.208 59.588-50.802v414.066z"
                    fill="#DFDFDF" p-id="9098"></path>
                <path
                    d="M946.492 888.89H190.544a6.97 6.97 0 0 1-6.97-6.97V353.808a6.97 6.97 0 0 1 6.97-6.97h647.724a6.97 6.97 0 0 1 6.97 6.97v76.492l96.604-81.946a6.98 6.98 0 0 1 4.51-1.654c3.848 0 7.11 3.12 7.11 6.97V881.92a6.97 6.97 0 0 1-6.97 6.97z m-748.978-13.94h742.008V368.604l-96.744 82.064a6.974 6.974 0 0 1-11.482-5.316v-84.574H197.514v514.172z"
                    fill="#4A555F" p-id="9099"></path>
                <path
                    d="M568.442 680.612a6.96 6.96 0 0 1-4.506-1.652L186.056 358.98l9.008-10.636 373.378 316.166L941.968 348.34l9.004 10.642-378.028 319.98c-1.298 1.1-2.9 1.65-4.502 1.65z"
                    fill="#4A555F" p-id="9100"></path>
                <path
                    d="M946.47 888.868H190.578a6.968 6.968 0 0 1-4.52-12.274l310.93-264.944a6.966 6.966 0 0 1 9.024-0.014l62.43 52.864 62.618-53.026a6.968 6.968 0 0 1 9.03 0.014l310.902 265.106a6.968 6.968 0 0 1 2.014 7.714 6.958 6.958 0 0 1-6.536 4.56z m-736.966-13.94h718.046L635.554 625.938l-62.606 53.012a6.978 6.978 0 0 1-9.012 0L501.52 626.1 209.504 874.928zM838.268 452.324a6.974 6.974 0 0 1-6.97-6.97v-84.584H102.342a6.97 6.97 0 0 1-6.97-6.97v-120.164a6.97 6.97 0 0 1 6.97-6.97h728.956V142.08a6.974 6.974 0 0 1 11.482-5.316l178.76 151.636a6.972 6.972 0 0 1 0 10.632l-178.762 151.638a6.976 6.976 0 0 1-4.51 1.654zM109.312 346.828h728.956a6.97 6.97 0 0 1 6.97 6.97v76.502l161.02-136.584-161.02-136.584v76.502a6.97 6.97 0 0 1-6.97 6.97H109.312v106.224z"
                    fill="#4A555F" p-id="9101"></path>
                <path d="M861.502 330.564H125.576v-73.696h735.926V192.256l119.61 101.46-119.61 101.462z" fill="#F58E6F"
                    p-id="9102"></path>
                <path
                    d="M0 529.684h276.076v13.94H0zM49.558 662.28h193.594v13.94H49.558zM143.37 593.664h183.782v13.94H143.37z"
                    fill="#4A555F" p-id="9103"></path>
            </svg>
            <p class="m-md-4 h6" style="line-height: 1.5;">To create a new account, <br>
                please send an email to <br>
                <a href="mailto:JNSGMS-28-10-AOS@outlook.com?subject=Register">JNSGMS-28-10-AOS@outlook.com</a><br>
                with the subject "Register"<br>
                in the email's subject line.
            </p>

            <button id="sent" class="btn btn-success w-100 mt-4">
                I have sent the email
            </button>
        </div>

        <form id="register-form" class="needs-validation" style="display:none" novalidate>
            <div class="account-form-body mt-3">
                <div class="form-group mb-3">
                    <label for="register-username">
                        Username
                    </label>
                    <input type="text" id="register-username" class="form-control input-block" autocapitalize="none"
                        autocorrect="off" autocomplete="username" autofocus required pattern="^[a-zA-Z0-9_]{4,16}$">
                    <div id="username-invalid-feedback" class="invalid-feedback">
                        Please enter a username that is between 4 and 16 characters long, and only contains letters,
                        numbers, and underscores ( _ ).
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="register-password">
                        Password
                    </label>
                    <input type="password" id="register-password" class="form-control input-block" autocapitalize="none"
                        autocorrect="off" autocomplete="new-password" autofocus required
                        pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d_]{8,16}$"
                        oninput="$('#register-repeat-password')[0].setCustomValidity($(this).val() === $('#register-repeat-password').val()?'':'Passwords do not match')">
                    <div class="invalid-feedback">
                        Please enter a password that is between 8 and 16 characters long, and only contains letters,
                        numbers, and underscores ( _ ). Your password must include at least one letter and one number.
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="register-repeat-password">
                        Repeat password
                    </label>
                    <input type="password" id="register-repeat-password" class="form-control input-block"
                        autocapitalize="none" autocorrect="off" autocomplete="new-password" autofocus required
                        pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d_]{8,16}$"
                        oninput="this.setCustomValidity($(this).val() === $('#register-password').val()?'':'Passwords do not match')">

                    <div class="invalid-feedback">
                        Please enter the same password as above.
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="register-email">
                        Email
                    </label>
                    <input type="email" id="register-email" class="form-control input-block" autocapitalize="none"
                        required pattern="^[a-zA-Z0-9_]+@[a-zA-Z0-9_]+(\.[a-zA-Z0-9_]+)+$">
                    <div class="invalid-feedback">
                        Please enter the same email address as the one you used to send the "register" email.
                    </div>
                </div>
                <input type="submit" value="Register" id="submit-btn" class="btn btn-success w-100">
            </div>
        </form>

        <p class="account-form-body bg-white text-center mt-3 mb-5">
            Already have an account?
            <a class="form-link" href="./login.html">Sign in</a>.
        </p>
    </div>

    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/core@4.2.4";

        const token = "Z2l0aHViX3BhdF8xMUFMM0xYTlEwQ3NHbW5FYVdtQWhWX3VhaEVwVTFQN1QxeGJJVzFtRzJTQUEzaUhTM2E5dW13WE9yNjJPUXlKSWZWWFROTURVRWRzdzRDVmMx";
        const octokit = new Octokit({ auth: window.atob(token) });

        const $registerForm = $("#register-form");
        const $usernameInput = $("#register-username");
        const $usernameFeedback = $("#username-invalid-feedback");
        const $submitBtn = $("#submit-btn");

        function showRegisterForm() {
            $("#register-send-a-mail").hide(1200);
            $registerForm.show(1500);
        }

        async function checkIfUsernameAlreadyExists(name) {
            const response = await fetch(`https://yubac.github.io/gs/users/${name}/profile.json`);
            return response.ok;
        }

        function validateUsernameInput() {
            $usernameInput[0].setCustomValidity("");
            $usernameFeedback.text("Please enter a username that is between 4 and 16 characters long, and only contains letters, numbers, and underscores ( _ ).");
            if ($usernameInput[0].checkValidity() === false) {
                return false;
            }
            return true;
        }

        function showRegistrationResult(status, reason = "") {
            switch (status) {
                case "success":
                    $('#register-success-modal').modal('show');
                    break;
                case "failure":
                    $('#register-failure-reason').html(reason);
                    $('#register-failure-modal').modal('show');
                    break;
            }
        }

        async function handleRegisterFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();
            $registerForm[0].classList.add('was-validated');
            if (!validateUsernameInput()) {
                return;
            }
            if ($registerForm[0].checkValidity() === false) {
                return;
            }
            const username = $usernameInput.val();
            const usernameAlreadyExists = await checkIfUsernameAlreadyExists(username);
            if (usernameAlreadyExists) {
                $usernameInput[0].setCustomValidity("This username is already taken. Please try another one.");
                $usernameFeedback.text("This username is already taken. Please try another one.");
                $registerForm[0].classList.add("was-validated");
                return;
            }
            $submitBtn.attr("disabled", true).val("Registering...");
            // octokit.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
            //     owner: 'YubaC',
            //     // repo: 'Github-Actions-Test',
            //     // workflow_id: '2.yml',
            //     repo: 'gt2',
            //     workflow_id: 'register.yml',
            //     ref: 'main',
            //     inputs: {
            //         name: $('#register-username').val(),
            //         password: $('#register-password').val(),
            //         email: $('#register-email').val()
            //     },
            //     mediaType: {
            //         format: 'json',
            //         previews: ['mockingbird']
            //     },
            // }).then(({ data, headers }) => {
            //     console.log(data);
            //     console.log(headers);
            //     if (!data) {
            //         showRegistrationResult("success");
            //         return;
            //     }
            //     const latestRun = data.workflow_runs[0];
            //     if (latestRun.status === 'completed' && latestRun.conclusion === 'cancelled') {
            //         throw new Error('Maximum workflow run rate exceeded.');
            //         // console.log('The workflow was cancelled due to exceeding the maximum concurrency.');
            //     }
            // }).catch((err) => {
            //     console.error(err);
            //     if (err.message.includes("API rate limit exceeded")) {
            //         const resetTime = new Date(err.response.headers["x-ratelimit-reset"] * 1000);
            //         showRegistrationResult("failure", `API rate limit exceeded. It will be reset at <time datetime="${resetTime.toISOString()}">${resetTime.toLocaleString()}</time>.`);
            //     } else if (err.message.includes("Maximum workflow run rate exceeded")) {
            //         showRegistrationResult("failure", "Another user is registing at this time. Please try again a few minutes later.");
            //     } else {
            //         showRegistrationResult("failure", err.message);
            //     }
            // }).finally(() => {
            //     $submitBtn.attr("disabled", false).val("Register");
            // });
            const owner = 'YubaC';
            const repo = 'gt2';
            const workflow_id = 'register.yml';
            const ref = 'main';

            // 获取仓库的工作流列表，判断当前工作流是否已经有正在运行的实例
            // 如果没有，则触发当前工作流
            octokit.request(`GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs?t=${Date.now().toString()}`, {
                owner: owner,
                repo: repo,
                workflow_id: workflow_id,
                // status: ['in_progress', 'queued', 'pending'],
                sort: 'created',
                direction: 'desc',
                per_page: 1,
                branch: ref
            }).then(({ data, headers }) => {
                // console.log(headers);
                if (data.workflow_runs && data.workflow_runs[0].conclusion === null) {
                    throw new Error('Another user is registing at this time. Please try again a few minutes later.');
                }

                return octokit.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches?t=${Date.now().toString()}', {
                    owner: owner,
                    repo: repo,
                    workflow_id: workflow_id,
                    ref: ref,
                    inputs: {
                        name: $('#register-username').val(),
                        password: $('#register-password').val(),
                        email: $('#register-email').val()
                    }
                });
            }).then(async ({ data, headers }) => {
                if (data) {
                    throw new Error(data);
                }
                console.log('The workflow has been triggered successfully.');
                showRegistrationResult("success");
            }).catch((err) => {
                console.error(err);
                if (err.message.includes("API rate limit exceeded")) {
                    const resetTime = new Date(err.headers["x-ratelimit-reset"] * 1000);
                    showRegistrationResult("failure", `API rate limit exceeded. It will be reset at ${resetTime.toLocaleString()}.`);
                } else {
                    showRegistrationResult("failure", err.message);
                }
            }).finally(() => {
                $submitBtn.attr("disabled", false).val("Register");
            });
        }

        $("#sent").on("click", showRegisterForm);
        $registerForm.on("submit", handleRegisterFormSubmit);
    </script>
</body>

</html>