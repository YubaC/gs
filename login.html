<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in | Yuba Technology</title>

    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./lib/fontawesome-free-5.15.4-web/css/all.min.css">
    <script src="./lib/jquery/js/jquery-3.6.3.min.js"></script>
</head>

<body>
    <link rel="stylesheet" href="css/account-form.css">

    <div class="header-logo pt-5 pb-4 text-center">
        <!-- <svg class="icon" style="width: 6em;height: 6em;vertical-align: middle;fill: currentColor;overflow: hidden;"
            viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5564">
            <path
                d="M933.4 209.6c-17.2-17.3-40.2-26.8-64.5-26.8H155.2c-50.3 0-91.3 40.9-91.3 91.3v475.8c0 50.3 40.9 91.3 91.3 91.3h713.5c50.3 0 91.3-40.9 91.3-91.3V274.1c0.1-24.4-9.4-47.3-26.6-64.5zM530.5 571.5c-4.9 4.9-11.4 7.6-18.4 7.6s-13.5-2.7-18.4-7.6L168.6 246.4h686.8L530.5 571.5z m-186.3-59.6L127.6 728.5V295.3l216.6 216.6z m44.8 45l59.6 59.6c16.9 16.9 39.5 26.3 63.4 26.3s46.5-9.3 63.4-26.3l59.6-59.6 220.5 220.5H168.6L389 556.9z m291-45l216.6-216.6v433.2L680 511.9z"
                fill="" p-id="5565"></path>
        </svg> -->
        <svg class="icon" style="width: 5em;height: 5em;vertical-align: middle;fill: currentColor;overflow: hidden;"
            viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="21361">
            <path
                d="M944.158 36.988H79.74c-22.65 0-41.042 18.442-41.042 41.094v684.666c0 22.598 18.39 41.042 41.042 41.042h864.416c22.65 0 41.042-18.444 41.042-41.042V78.082c0-22.65-18.39-41.094-41.04-41.094z m20 669.548h-95.226l17.092 17.092c4.208 4.26 4.208 11.118 0 15.326l-17.404 17.404-17.404 17.352a10.724 10.724 0 0 1-15.274 0l-48.054-48.054c-5.35-5.35-14.39-3.688-17.508 3.222l-11.74 25.976c-4 8.884-16.78 8.364-20.054-0.78l-17.04-47.534H59.74V66.964h904.42v639.572z"
                fill="#DFDFDF" p-id="21362"></path>
            <path
                d="M665.904 961.258H367.646a7.79 7.79 0 0 1-7.194-10.79l50.222-120.484a7.794 7.794 0 0 1 7.194-4.794h197.81c3.146 0 5.982 1.892 7.194 4.794l50.226 120.484a7.798 7.798 0 0 1-7.194 10.79z m-286.57-15.584h274.88l-43.732-104.898h-187.42l-43.728 104.898z"
                fill="#4A555F" p-id="21363"></path>
            <path d="M411.434 924.278l25.888-62.104h158.9l25.888 62.104z" fill="#DFDFDF" p-id="21364"></path>
            <path
                d="M799.424 1024h-565.3a7.794 7.794 0 0 1-7.792-7.792v-62.742a7.792 7.792 0 0 1 7.792-7.792h565.3a7.794 7.794 0 0 1 7.792 7.792v62.742a7.794 7.794 0 0 1-7.792 7.792z m-557.508-15.586h549.714v-47.156H241.916v47.156z"
                fill="#4A555F" p-id="21365"></path>
            <path d="M35.934 1008.414h961.676V1024H35.934z" fill="#4A555F" p-id="21366"></path>
            <path d="M517.528 756.144m-37.862 0a37.862 37.862 0 1 0 75.724 0 37.862 37.862 0 1 0-75.724 0Z"
                fill="#FFFFFF" p-id="21367"></path>
            <path
                d="M517.528 801.798c-25.174 0-45.656-20.482-45.656-45.656s20.482-45.656 45.656-45.656 45.656 20.482 45.656 45.656c-0.002 25.174-20.482 45.656-45.656 45.656z m0-75.724c-16.58 0-30.07 13.488-30.07 30.07 0 16.58 13.49 30.07 30.07 30.07s30.07-13.488 30.07-30.07-13.49-30.07-30.07-30.07z"
                fill="#4A555F" p-id="21368"></path>
            <path
                d="M944.208 840.78H79.792c-23.342 0-45.28-10.348-60.19-28.39a74.262 74.262 0 0 1-4.53-6.042 78.596 78.596 0 0 1-3.906-6.448 73.532 73.532 0 0 1-3.278-6.776 75.804 75.804 0 0 1-2.608-7.186 75.904 75.904 0 0 1-2.602-11.33 74.174 74.174 0 0 1-0.918-11.858V78.082C1.76 35.028 36.766 0 79.792 0h864.414c43.028 0 78.034 35.028 78.034 78.082v684.666c0 43.026-35.006 78.032-78.032 78.032zM79.792 15.586c-34.432 0-62.448 28.036-62.448 62.498v684.666c0 3.3 0.244 6.478 0.73 9.446a59.74 59.74 0 0 0 2.086 9.114 59.086 59.086 0 0 0 4.688 11.128c1.01 1.88 2.076 3.592 3.186 5.26a60.274 60.274 0 0 0 3.586 4.772c11.932 14.44 29.496 22.726 48.172 22.726h864.414c34.432 0 62.448-28.012 62.448-62.446V78.082c0-34.46-28.016-62.498-62.448-62.498H79.792z"
                fill="#4A555F" p-id="21369"></path>
            <path
                d="M843.582 784.698a18.396 18.396 0 0 1-13.18-5.51l-48.024-48.024a2.944 2.944 0 0 0-2.668-0.834 2.974 2.974 0 0 0-2.228 1.752l-11.74 25.978c-3.126 6.946-9.938 11.246-17.706 10.948a18.526 18.526 0 0 1-16.788-12.308l-63.59-177.528a18.094 18.094 0 0 1-1.126-6.358c0-5.98 2.968-11.644 7.934-15.152 4.998-3.528 11.182-4.374 16.956-2.322l177.542 63.598a18.524 18.524 0 0 1 12.348 16.778 18.52 18.52 0 0 1-10.948 17.716l-25.966 11.738a2.968 2.968 0 0 0-1.75 2.22c-0.112 0.594-0.148 1.74 0.858 2.754l48.03 47.978c0.01 0.012 0.026 0.022 0.036 0.036 7.194 7.288 7.178 19.09-0.036 26.308l-34.814 34.766a18.388 18.388 0 0 1-13.14 5.466z m-63.336-70.002c4.886 0 9.63 1.93 13.15 5.448l48.054 48.056c0.792 0.798 1.67 0.912 2.13 0.912a2.94 2.94 0 0 0 2.096-0.88l34.838-34.788c1.172-1.174 1.162-3.114-0.026-4.328l-48.024-47.974a18.714 18.714 0 0 1-5.144-16.592 18.644 18.644 0 0 1 10.66-13.586l25.97-11.74c1.634-0.734 1.822-2.118 1.79-2.878-0.03-0.762-0.334-2.132-2.02-2.732l-177.538-63.594a2.894 2.894 0 0 0-2.73 0.372c-0.838 0.592-1.34 1.498-1.34 2.422 0 0.368 0.05 0.67 0.172 0.982l63.63 177.646c0.594 1.664 1.968 1.964 2.73 1.992 0.74 0.038 2.152-0.158 2.882-1.78l11.744-25.986a18.64 18.64 0 0 1 16.976-10.972z"
                fill="#4A555F" p-id="21370"></path>
            <path
                d="M806.256 707.286a36.512 36.512 0 0 0-25.98-10.776 36.92 36.92 0 0 0-29.454 14.72l-40.592-113.282 113.286 40.58a36.84 36.84 0 0 0-14.074 22.718 36.89 36.89 0 0 0 10.074 32.662l37.436 37.386-13.356 13.336-37.34-37.344z"
                fill="#F58E6F" p-id="21371"></path>
            <path
                d="M935.014 685.132H839.68a7.788 7.788 0 0 1-5.514-2.288l-1.71-1.714a18.706 18.706 0 0 1-5.134-16.58 18.644 18.644 0 0 1 10.66-13.586l25.97-11.74c1.634-0.734 1.822-2.118 1.79-2.878-0.03-0.762-0.334-2.132-2.02-2.732l-177.538-63.594c-1.552-0.556-2.644 0.216-3.156 0.73-0.508 0.508-1.268 1.592-0.706 3.154l36.112 100.808a7.776 7.776 0 0 1-0.964 7.114 7.798 7.798 0 0 1-6.372 3.306H88.986a7.794 7.794 0 0 1-7.792-7.792V96.162a7.792 7.792 0 0 1 7.792-7.792h846.028a7.794 7.794 0 0 1 7.792 7.792V677.34a7.792 7.792 0 0 1-7.792 7.792z m-91.98-15.586h84.188V103.954H96.778v565.592h603.254l-32.368-90.364c-2.466-6.82-0.812-14.276 4.328-19.432 5.14-5.164 12.602-6.856 19.446-4.404l177.528 63.59a18.524 18.524 0 0 1 12.348 16.778 18.52 18.52 0 0 1-10.948 17.716l-25.966 11.738a2.968 2.968 0 0 0-1.75 2.22c-0.092 0.48-0.134 1.32 0.384 2.158z"
                fill="#4A555F" p-id="21372"></path>
            <path
                d="M935.02 685.112h-95.328a7.79 7.79 0 0 1-5.504-2.278l-1.714-1.712a18.722 18.722 0 0 1-5.14-16.596 18.634 18.634 0 0 1 10.66-13.582l25.966-11.738c1.634-0.736 1.826-2.118 1.796-2.878-0.03-0.764-0.334-2.132-2.024-2.732L686.2 569.998c-1.568-0.558-2.644 0.224-3.156 0.732-0.508 0.508-1.274 1.594-0.706 3.156l36.112 100.806a7.776 7.776 0 0 1-0.964 7.114 7.798 7.798 0 0 1-6.372 3.306H88.996a7.794 7.794 0 0 1-7.792-7.792V96.142a7.792 7.792 0 0 1 7.792-7.792H935.02a7.794 7.794 0 0 1 7.792 7.792V677.32a7.794 7.794 0 0 1-7.792 7.792z m-91.976-15.586h84.182V103.934H96.788v565.592h603.254l-32.374-90.364c-2.466-6.822-0.806-14.276 4.332-19.434 5.144-5.164 12.598-6.854 19.446-4.404l177.516 63.59a18.53 18.53 0 0 1 12.358 16.778 18.52 18.52 0 0 1-10.948 17.716l-25.97 11.738a2.974 2.974 0 0 0-1.746 2.22c-0.088 0.482-0.128 1.322 0.388 2.16z"
                fill="#4A555F" p-id="21373"></path>
            <path
                d="M175.08 636.794h-15.586V200.458c0-29.934 24.378-54.288 54.34-54.288h596.348c29.964 0 54.34 24.354 54.34 54.288v383.09h-15.586V200.458c0-21.34-17.386-38.702-38.756-38.702H213.836c-21.37 0-38.756 17.362-38.756 38.702v436.336z"
                fill="#4A555F" p-id="21374"></path>
            <path
                d="M193.264 280.27v356.522h472l-17.43-52.548c-9.542-28.766 17.862-56.076 46.594-46.436l136.328 45.738V280.27H193.264z"
                fill="#FFD452" p-id="21375"></path>
            <path d="M167.282 243.732h689.668v15.586H167.282z" fill="#4A555F" p-id="21376"></path>
            <path d="M240.936 203.156m-20.394 0a20.394 20.394 0 1 0 40.788 0 20.394 20.394 0 1 0-40.788 0Z"
                fill="#F58E6F" p-id="21377"></path>
            <path d="M307.514 203.156m-20.396 0a20.396 20.396 0 1 0 40.792 0 20.396 20.396 0 1 0-40.792 0Z"
                fill="#F58E6F" p-id="21378"></path>
            <path d="M374.092 203.156m-20.394 0a20.394 20.394 0 1 0 40.788 0 20.394 20.394 0 1 0-40.788 0Z"
                fill="#F58E6F" p-id="21379"></path>
            <path
                d="M329.088 477.358h-0.086a7.786 7.786 0 0 1-6.914-4.37l-36.386-74.43 14.002-6.844 29.578 60.502 18.776-36.352a7.796 7.796 0 0 1 13.852 0.002l18.772 36.35 29.578-60.5 14.002 6.844-36.386 74.43a7.788 7.788 0 0 1-6.914 4.37c-3.06-0.078-5.662-1.598-7.012-4.218l-18.964-36.72-18.97 36.722a7.804 7.804 0 0 1-6.928 4.214zM542.606 477.358a7.796 7.796 0 0 1-6.926-4.218l-18.964-36.72-18.964 36.72c-1.354 2.62-4.058 4.16-7.012 4.218a7.8 7.8 0 0 1-6.916-4.37l-36.392-74.43 14.002-6.846 29.582 60.502 18.772-36.35a7.796 7.796 0 0 1 13.852 0l18.772 36.35 29.578-60.5 14.002 6.844-36.386 74.43a7.788 7.788 0 0 1-6.916 4.37h-0.084zM704.338 477.358a7.796 7.796 0 0 1-6.926-4.218l-18.964-36.72-18.964 36.72c-1.354 2.62-3.952 4.16-7.012 4.218a7.786 7.786 0 0 1-6.914-4.37l-36.386-74.43 14.002-6.844 29.578 60.5 18.772-36.35a7.796 7.796 0 0 1 13.852 0l18.772 36.35 29.578-60.5 14.002 6.844-36.386 74.43a7.788 7.788 0 0 1-6.914 4.37h-0.09zM428.866 459.244h15.586v14.968h-15.586zM592.08 459.244h15.586v14.968h-15.586z"
                fill="#4A555F" p-id="21380"></path>
        </svg>
    </div>

    <div class="account-form">
        <div class="account-form-header text-center mb-3 p-0">
            <h1>Sign in to Yuba Technology</h1>
        </div>

        <div id="sign-in-result"></div>
        <form id="sign-in-form">
            <div class="account-form-body mt-3">
                <div class="form-group position-relative mb-3">
                    <label for="login-username">
                        Username or email address
                    </label>
                    <input type="text" id="login-username" class="form-control input-block" autocapitalize="none"
                        autocorrect="off" autocomplete="username" autofocus="autofocus">
                </div>

                <div class="form-group position-relative mb-3">
                    <label for="login-password">
                        Password
                    </label>
                    <input type="password" id="login-password" class="form-control input-block" autocapitalize="none"
                        autocorrect="off" autocomplete="username" autofocus="autofocus">
                    <a class="form-link label-link position-absolute top-0 end-0" id="forgot-password" tabindex="0"
                        href="/password_reset">Forgot password?</a>
                </div>

                <input type="submit" value="Sign in" id="login-submit" class="btn btn-success w-100">
            </div>
        </form>

        <p class="account-form-body bg-white text-center mt-3">
            New to Here?
            <a class="form-link" href="./register.html">Create an account</a>.
        </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/core@4.2.4";
        const token = "Z2l0aHViX3BhdF8xMUFMM0xYTlEwQ3NHbW5FYVdtQWhWX3VhaEVwVTFQN1QxeGJJVzFtRzJTQUEzaUhTM2E5dW13WE9yNjJPUXlKSWZWWFROTURVRWRzdzRDVmMx"

        const octokit = new Octokit({ auth: window.atob(token) });

        function showError(message) {
            $("#sign-in-result").html(`<div class="alert alert-danger alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
            $("#sign-in-result").find(".btn-close").focus();
        }

        function showSuccess(message) {
            $("#sign-in-result").html(`<div class="alert alert-success alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
            $("#sign-in-result").find(".btn-close").focus();
        }

        async function sha256(data) {
            const encoder = new TextEncoder();
            const dataBuffer = encoder.encode(data);

            const hashBuffer = await crypto.subtle.digest("SHA-256", dataBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray
                .map((byte) => byte.toString(16).padStart(2, "0"))
                .join("");
            return hashHex;
        }

        async function verifySignature(data, key, signature) {
            // 计算密钥的 SHA256 哈希值，然后转换成16进制字符串，最后转换为字节数组
            // key的类型是字符串
            if (!data || !key || !signature) {
                return false;
            }

            key = await sha256(key);

            // 将密钥转换为字节数组
            const keyBytes = new TextEncoder().encode(key);

            // 将签名结果转换为字节数组
            const signatureBytes = Uint8Array.from(signature.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

            // 使用 HMAC-SHA256 算法验证签名
            return crypto.subtle.importKey("raw", keyBytes, { name: "HMAC", hash: "SHA-256" }, false, ["verify"])
                .then(key => crypto.subtle.verify("HMAC", key, signatureBytes, new TextEncoder().encode(data)))
                .then(result => {
                    return result;
                })
                .catch(error => {
                    console.error(error);
                    return false;
                });
        }

        // base64解密的函数
        function b64DecodeUnicode(str) {
            return decodeURIComponent(atob(str).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        async function getFileFromGithub(fileName) {
            // If cannot send a response, it will auto throw an error.
            // Usually this is because of network error.
            const response = await fetch("https://api.github.com/repos/YubaC/gs/contents/" + fileName, {
                method: "get",
            });
            // The response is already created, so we can use it.
            // The network is ok then.
            try {
                if (!response.ok) {
                    throw new Error("Network response was not ok. " + response.status + " " + response.statusText);
                }
                const data = await response.json();
                return {
                    ok: true,
                    data: b64DecodeUnicode(data.content),
                };
            } catch (error) {
                return {
                    ok: false,
                    error: error,
                };
            }
        }

        $("#sign-in-form").on("submit", async function (e) {
            e.preventDefault();
            // 尝试请求yubac.github.io/gs/data/users/{username}/profile.json
            // 如果请求成功，显示用户信息
            // 如果请求失败，显示用户不存在
            const $username = $("#login-username")
            const usernameInputed = $username.val();
            const $password = $("#login-password");
            const password = $password.val();
            const $loginSubmit = $("#login-submit");

            $loginSubmit.val("Singing in...").attr("disabled", "true");

            const getUserName = async (userInput) => {
                if (!/^[a-zA-Z0-9_]+@[a-zA-Z0-9_]+(\.[a-zA-Z0-9_]+)+$/.test(userInput)) {
                    return userInput;
                }
                const response = await getFileFromGithub(`users/email_${await sha256(userInput)}`);
                if (!response.ok) {
                    console.error(response.status);
                    throw new Error("Invalid username or email address.");
                }
                return await response.data;
            }

            const fetchProfile = async (username) => {
                const response = await getFileFromGithub(`users/${username}/profile.json`);
                if (!response.ok) {
                    console.error(response.error);
                    // 如果是网络错误，则没有必要抛出错误，因为上面的getFileFromGithub已经抛出了错误
                    // 否则抛出用户不存在的错误
                    if (response.error) {
                        console.error(response.error);
                        // throw response.error;
                    } else {
                        throw new Error("Invalid username or email address.");
                    }
                }

                return JSON.parse(response.data);
            };

            try {
                const username = await getUserName(usernameInputed);
                const data = await fetchProfile(username);
                if (await verifySignature(data.id, password, data.signature)) {
                    showSuccess(`Hi ${username}!`);
                } else {
                    throw new Error("Invalid password.");
                }
            } catch (error) {
                switch (error.message) {
                    case "Invalid username or email address.":
                        $username.val("");
                        $password.val("");
                        break;
                    case "Invalid password.":
                        $password.val("");
                        break;
                }
                showError(error.message);
            }
            $loginSubmit.val("Sing in").removeAttr("disabled");
        });
    </script>
</body>

</html>